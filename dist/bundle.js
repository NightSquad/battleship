(()=>{"use strict";const e=class{constructor(e){this.name=e,this._ships=[],this._gameBoard=null,this.sunks=[]}get ships(){return this._ships}set ships(e){return this._ships=e}get gameBoard(){return this._gameBoard}set gameBoard(e){return this._gameBoard=e}};class t{constructor(e){this.board=e,this.checked=[]}receiveAttack(e,t,s,l){return t.ships.some((c=>c.coord.some((i=>{if(JSON.stringify(i)==JSON.stringify([s,l])){if(this.checked.push([s,l]),e.currentTarget?c.hit(e):c.hit([s,l]),c.isSunk()){if(c.coord.forEach((e=>{this.board.childNodes[e[0]].childNodes[e[1]].style.backgroundColor="orange"})),t.sunks.push(c),10==a[d].sunks.length&&function(e){let t=document.createElement("div");t.className="win",t.addEventListener("click",(e=>{e.currentTarget.style.display="none"}));let o=document.createElement("div");o.className="winnerBox";let d=document.createElement("p");d.className="winner",d.textContent=`Победил ${e.name}`;let a=document.createElement("div");a.className="choosePrepare";let s=document.createElement("button");s.className="chooseButton",s.textContent="Restart";let l=document.createElement("button");l.className="chooseButton",l.textContent="Close",s.addEventListener("click",n),l.addEventListener("click",(e=>{for(let e=0;e<10;e++)for(let t=0;t<10;t++)r.gameBoard.board.childNodes[e].childNodes[t].disabled="true";t.remove()})),a.append(s,l),o.append(d,a),t.append(o),document.body.append(t)}(a[o]),1==c.coord.length)return this.board.childNodes[c.coord[0][0]].childNodes[c.coord[0][1]-1]&&(this.board.childNodes[c.coord[0][0]].childNodes[c.coord[0][1]-1].style.backgroundColor="black"),this.board.childNodes[c.coord[0][0]].childNodes[c.coord[0][1]+1]&&(this.board.childNodes[c.coord[0][0]].childNodes[c.coord[0][1]+1].style.backgroundColor="black"),this.board.childNodes[c.coord[0][0]+1]&&(this.board.childNodes[c.coord[0][0]+1].childNodes[c.coord[0][1]].style.backgroundColor="black"),this.board.childNodes[c.coord[0][0]-1]&&(this.board.childNodes[c.coord[0][0]-1].childNodes[c.coord[0][1]].style.backgroundColor="black"),this.checked.push([c.coord[0][0],c.coord[0][1]-1],[c.coord[0][0],c.coord[0][1]+1],[c.coord[0][0]+1,c.coord[0][1]],[c.coord[0][0]-1,c.coord[0][1]]),!0;"Vertical"==c.type&&(this.board.childNodes[c.coord[0][0]-1]&&(this.board.childNodes[c.coord[0][0]-1].childNodes[c.coord[0][1]].style.backgroundColor="black"),this.board.childNodes[c.coord[c.coord.length-1][0]+1]&&(this.board.childNodes[c.coord[c.coord.length-1][0]+1].childNodes[c.coord[c.coord.length-1][1]].style.backgroundColor="black"),this.checked.push([c.coord[0][0]-1,c.coord[0][1]],[c.coord[c.coord.length-1][0]+1,c.coord[c.coord.length-1][1]])),"Horizontal"==c.type&&(this.board.childNodes[c.coord[0][0]].childNodes[c.coord[c.coord.length-1][1]+1]&&(this.board.childNodes[c.coord[0][0]].childNodes[c.coord[c.coord.length-1][1]+1].style.backgroundColor="black"),this.board.childNodes[c.coord[0][0]].childNodes[c.coord[0][1]-1]&&(this.board.childNodes[c.coord[0][0]].childNodes[c.coord[0][1]-1].style.backgroundColor="black"),this.checked.push([c.coord[0][0],c.coord[c.coord.length-1][1]+1],[c.coord[0][0],c.coord[0][1]-1]))}return!0}this.board.childNodes[s].childNodes[l].style.backgroundColor="black"}))))}}let o=0,d=1,r=new e("computer"),a=[];function s(){a.push(m,r),document.getElementsByClassName("gameBoard")[1].style.display="flex";let e,t=r.gameBoard.board;f(t),B(r);for(let d=0;d<10;d++)for(let a=0;a<10;a++)e=t.childNodes[d].childNodes[a],e.addEventListener("click",(function(e){0==o&&(r.gameBoard.checked.some((e=>JSON.stringify(e)==JSON.stringify([d,a])))||(r.gameBoard.checked.push([d,a]),r.gameBoard.receiveAttack(e,r,d,a)||(c(),l())))}))}function n(){for(let e=0;e<a.length;e++){a[e].gameBoard.checked=[],a[e].ships=[],a[e].sunks=[],B(a[e]);for(let t=0;t<10;t++)for(let o=0;o<10;o++)a[e].gameBoard.board.childNodes[t].childNodes[o].style.background="none"}y(m,m.gameBoard.board)}function l(){let e=k(10),t=k(10);return m.gameBoard.checked.some((o=>JSON.stringify(o)==JSON.stringify([e,t])))?l():(console.log(`Компьютер сходил в точку ${e}:${t}`),m.gameBoard.receiveAttack("_",m,e,t)?void l():(m.gameBoard.checked.push([e,t]),m.gameBoard.board.childNodes[e].childNodes[t].style.backgroundColor="black",void c()))}function c(){if(0==o)return o=1,void(d=0);o=0,d=1}r.gameBoard=new t(document.getElementsByClassName("playerBoard")[1]);class i{constructor(){this.coord=[],this.Board=null,this.type=null}hit=e=>{let t,o;e.currentTarget?(t=parseInt(e.currentTarget.dataset.num,10),o=parseInt(e.currentTarget.dataset.char,10),this.Board=e.currentTarget.parentElement.parentElement):(t=e[0],o=e[1],this.Board=a[d].gameBoard.board),this.Board.childNodes[t-1]&&(this.Board.childNodes[t-1].childNodes[o-1]&&(this.Board.childNodes[t-1].childNodes[o-1].style.backgroundColor="black"),this.Board.childNodes[t-1].childNodes[o+1]&&(this.Board.childNodes[t-1].childNodes[o+1].style.backgroundColor="black")),this.Board.childNodes[t+1]&&(this.Board.childNodes[t+1].childNodes[o-1]&&(this.Board.childNodes[t+1].childNodes[o-1].style.backgroundColor="black"),this.Board.childNodes[t+1].childNodes[o+1]&&(this.Board.childNodes[t+1].childNodes[o+1].style.backgroundColor="black")),this.Board.childNodes[t].childNodes[o].style.backgroundColor="red"};isSunk=()=>{let e=0;for(let t=0;t<this.coord.length;t++)"red"==this.Board.childNodes[this.coord[t][0]].childNodes[this.coord[t][1]].style.backgroundColor&&e++;return e==this.coord.length}}const h=new class{success(e){let t=document.getElementsByClassName("modal")[0],o=document.createElement("div");o.addEventListener("animationiteration",(e=>{o.style.animationPlayState="paused",setTimeout((()=>o.style.animationPlayState="running"),2e3)})),o.addEventListener("animationend",(e=>{o.remove()})),o.classList.add("notify"),o.style.backgroundColor="green";let d=document.createElement("p");d.textContent=e,o.append(d),t.prepend(o)}fail(e){let t=document.getElementsByClassName("modal")[0],o=document.createElement("div");o.addEventListener("animationiteration",(e=>{o.style.animationPlayState="paused",setTimeout((()=>o.style.animationPlayState="running"),2e3)})),o.addEventListener("animationend",(e=>{o.remove()})),o.classList.add("notify"),o.style.backgroundColor="brown";let d=document.createElement("p");d.textContent=e,o.append(d),t.prepend(o)}};let u=document.getElementsByClassName("playerBoard")[0],g=document.getElementsByClassName("gameBoard")[0],m=new e("Player");m.gameBoard=new t(u);let N=[4,3,2,1],p=[];function b(e){let t=document.createElement("div");t.className="submarine",t.draggable="true";for(let o=0;o<e;o++){let e=document.createElement("button");t.append(e)}return t.style.height=25*e+"px",t.addEventListener("dragstart",L),t.addEventListener("dblclick",(t=>{t.currentTarget.classList.toggle("horizontal"),"horizontal"==t.currentTarget.classList[1]&&(t.currentTarget.style.height=""),t.currentTarget.classList[1]||(t.currentTarget.style.height=25*e+"px")})),t}function f(e){for(let t=0;t<10;t++){let o=document.createElement("div");o.className="line",o.id=t;for(let e=0;e<10;e++){let d=document.createElement("button");d.className="field",d.classList.add("droppable"),d.dataset.num=t,d.dataset.char=e,o.append(d)}e.append(o)}}function y(e,t){for(let o=0;o<e.ships.length;o++){let d=e.ships[o].coord;for(let e=0;e<d.length;e++)t.childNodes[d[e][0]].childNodes[d[e][1]].style.backgroundColor="blue"}}function k(e){return Math.floor(Math.random()*e)}function B(e){function t(e){let t=k(2);return t=0==t?v:E,t([k(10),k(10)],e)}for(let e=N.length-1;e>=0;e--)for(let o=0;o<N[e];o++){let o=0;for(;o++,!t(e+1);)if(2e3==o){o=0,h.fail("alarm");break}}e.ships=p,p=[]}function v(e,t){let o,d;e.target?(o=parseInt(e.target.dataset.num,10),d=parseInt(e.target.dataset.char,10)):(o=e[0],d=e[1]);for(let r=0;r<3;r++)for(let a=0;a<t+2;a++)if(p.some((e=>e.coord.some((e=>JSON.stringify(e)==JSON.stringify([o-1+r,d-1+a]))))))return e.target&&h.fail("Рядом есть другой корабль"),!1;if(!u.childNodes[o].childNodes[d+t-1])return e.target&&h.fail("Корабль выходит за границы"),!1;let r=[];for(let e=0;e<t;e++)r.push([o,d+e]);let a=new i;return a.coord=r,a.type="Horizontal",p.push(a),!0}function E(e,t){let o,d;e.target?(o=parseInt(e.target.dataset.num,10),d=parseInt(e.target.dataset.char,10)):(o=e[0],d=e[1]);for(let r=0;r<t+2;r++)for(let t=0;t<3;t++)if(p.some((e=>e.coord.some((e=>JSON.stringify(e)==JSON.stringify([o-1+r,d-1+t]))))))return e.target&&h.fail("Рядом есть другой корабль"),!1;if(!u.childNodes[o+t-1])return e.target&&h.fail("Корабль выходит за границы"),!1;let r=[];for(let e=0;e<t;e++)r.push([o+e,d]);let a=new i;return a.coord=r,a.type="Vertical",p.push(a),!0}let C=null;function L(e){e.dataTransfer.effectAllowed="move",C=e.target}function T(){let e=p[p.length-1].coord;for(let t=0;t<e.length;t++)u.childNodes[e[t][0]].childNodes[e[t][1]].style.backgroundColor="blue"}u.addEventListener("dragleave",(function(e){"blue"!=e.target.style.backgroundColor&&(e.target.style.background="none")})),u.addEventListener("dragover",(function(e){e.preventDefault(),e.dataTransfer.dropEffect="move","blue"!=e.target.style.backgroundColor&&(e.target.style.backgroundColor="pink")})),u.addEventListener("drop",(function(e){return e.preventDefault(),"horizontal"==C.classList[1]?v(e,C.getElementsByTagName("button").length)?(C.remove(),C=null,T(),void(10==p.length&&(m.ships=p,hint.remove(),p=[],s()))):void("pink"==e.target.style.backgroundColor&&(e.target.style.background="none")):E(e,C.getElementsByTagName("button").length)?(C.remove(),C=null,T(),void(10==p.length&&(hint.remove(),m.ships=p,p=[],s()))):void("pink"==e.target.style.backgroundColor&&(e.target.style.background="none"))})),auto.addEventListener("click",(()=>{B(m),y(m,u),document.getElementsByClassName("choosePrepare")[0].style.display="none",s()})),manual.addEventListener("click",(()=>{!function(){let e=document.createElement("div");e.className="ships";for(let t=0;t<=N.length;t++)for(let o=0;o<N[t];o++)e.append(b(t+1));let t=document.createElement("p");t.textContent="Чтобы развернуть корабль - кликните по нему дважды. Корабль ставится относительно левой/верхней координаты",t.id="hint",g.append(t,e)}(),document.getElementsByClassName("choosePrepare")[0].style.display="none"})),f(document.getElementsByClassName("playerBoard")[0])})();